#!/opt/pwn.college/bash

REPO_DIR="/tmp/repo"
TARGET_FILE="app.py"
EXPECTED_FILE="/expected_app.py"

git config --global --add safe.directory /tmp/repo

# Ensure the repository exists
if [ ! -d "$REPO_DIR/.git" ]; then
    echo "[-] Git repository does not exist, or the .git folder has been deleted"
    exit 1
fi

cd "$REPO_DIR"

# Check if current branch is master
current_branch=$(git symbolic-ref --short HEAD)
if [[ "$current_branch" != "master" ]]; then
    echo "[-] You are not on the master branch. Please switch back to the master branch"
    exit 1
fi

# Check for merge commits (not allowed)
if git log --oneline --merges | grep -q .; then
    echo "[-] Merge commit detected. Only cherry-pick is allowed in this level!"
    exit 1
fi

# Check for the correct commit (by commit message)
if ! git log --oneline | grep -q "feat: add run() function"; then
    echo "[-] Could not find the commit that adds the run() function. Please cherry-pick the correct commit"
    exit 1
fi

# Check that app.py matches expected content
if ! diff -q "$TARGET_FILE" "$EXPECTED_FILE" > /dev/null; then
    echo "[-] app.py content does not match expected. Please correctly cherry-pick the target commit"
    exit 1
fi

# Check for uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
    echo "[-] There are uncommitted changes in the repository. Please keep the working directory clean"
    exit 1
fi

# Check that there are exactly 2 commits on master
commit_count=$(git rev-list --count HEAD)
if [ "$commit_count" -ne 2 ]; then
    echo "[-] The number of commits on the master branch is not 2. Do not use rebase or other operations"
    exit 1
fi

echo "[+] Cherry-pick was successful and app.py is correct. Here is your flag:"
cat /flag
