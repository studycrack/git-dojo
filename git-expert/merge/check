#!/opt/pwn.college/bash
set -e
repo=$PWD 

git config --global --add safe.directory /tmp/repo

# 1) story.txt must contain both key phrases
grep -q "A quick PATCH on master"    story.txt || { echo "[-] Missing PATCH line"; exit 1; }
grep -q "An exciting FEATURE begins" story.txt || { echo "[-] Missing FEATURE line"; exit 1; }

# 2) HEAD must be a merge commit (i.e., has two parents)
parents=$(git rev-list --parents -n 1 HEAD | wc -w)
if [[ "$parents" -lt 3 ]]; then
  echo "[-] The current HEAD is not a merge commit. Use git merge or commit after resolving conflicts"
  exit 1
fi

# 3) The two parents of the merge must come from master & feature
master_base=$(cat /challenge/master_base)
feature_tip=$(cat /challenge/feature_head)
git merge-base --is-ancestor "$master_base" HEAD^1 2>/dev/null && \
git merge-base --is-ancestor "$feature_tip" HEAD^2 2>/dev/null || {
  echo "[-] Merge parents do not match expectations. Make sure you're merging feature into master"
  exit 1
}

echo "[+] Congratulations! Successfully resolved conflicts and merged branches."
echo -n "Your flag is: "
cat /flag
