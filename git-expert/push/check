#!/opt/pwn.college/bash

set -e

git config --global --add safe.directory /tmp/repo

repo=$PWD
expected=$(cat /challenge/target_commit)
remote_url=$(cat /challenge/remote_path)

# 1) Must be run from the root of the Git repo
if [[ ! -d .git ]]; then
  echo "[-] Please run /challenge/check from the repository directory"
  exit 1
fi

# 2) A remote named 'origin' must exist
if ! git remote | grep -qx origin; then
  echo "[-] Remote 'origin' not detected"
  exit 1
fi

# 3) 'origin' must point to the expected bare repo path
if [[ $(git remote get-url origin) != "$remote_url" ]]; then
  echo "[-] The URL of 'origin' is incorrect"
  exit 1
fi

# 4) Remote master branch must point to the expected commit
remote_commit=$(git ls-remote origin refs/heads/master | cut -f1)
if [[ -z "$remote_commit" || "$remote_commit" != "$expected" ]]; then
  echo "[-] Remote master branch does not yet contain the latest commit"
  exit 1
fi

# 5) Local master must be tracking origin/master
if ! git rev-parse --abbrev-ref --symbolic-full-name @{u} \
       | grep -qx "origin/master"; then
  echo "[-] Local master is not set to track origin/master"
  exit 1
fi

echo "[+] Push successful and tracking is set!"
echo -n "Your flag is: "
cat /flag
