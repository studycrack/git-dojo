#!/opt/pwn.college/bash

git config --global --add safe.directory /tmp/repo

cd /tmp/repo

# Must be on the master branch
current_branch=$(git symbolic-ref --short HEAD)
if [[ "$current_branch" != "master" ]]; then
    echo "[-] You are not on the master branch. Please merge your results back to master."
    exit 1
fi

# Check for commits from the feature branch (assumed by commit message)
if ! git log --oneline | grep -q "Add line 3 on feature"; then
    echo "[-] Missing commits from the feature branch."
    exit 1
fi

if ! git log --oneline | grep -q "Add line 4 on feature"; then
    echo "[-] Missing commits from the feature branch."
    exit 1
fi

# Check for linear history (no merge commits)
if git log --merges | grep .; then
    echo "[-] Merge commits found. Please use rebase instead of merge."
    exit 1
fi

# Check that the final content of the file is correct
expected="Line 1
Line 2
Line 3 from feature
Line 4 from feature"
actual=$(cat /tmp/repo/file.txt)

if [[ "$actual" != "$expected" ]]; then
    echo "[-] The content of file.txt is incorrect. Please ensure the merge order and content are correct."
    exit 1
fi

echo "[+] Congratulations! You have successfully completed the linear merge task. Here is your flag:"
cat /flag
